<!DOCTYPE html>
<!--
Copyright 2018 The Go Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<html>
<head>
    <meta charset="utf-8"/>
    <title>Go wasm</title>
</head>

<body>
<script src="wasm_exec.js"></script>
{{/*tone js for sound, canvas for drawing*/}}
<input type="file" id="file">
<canvas id="screen"></canvas>
<button onclick="run()">Run</button>
<script>
    document.buffer = new Uint8Array(0xFFF);

    let context = new AudioContext()
    let o = context.createOscillator()
    let g = context.createGain()

    function playMusic() {
        context = new AudioContext()
        o = context.createOscillator()
        g = context.createGain()
        o.connect(g)
        g.connect(context.destination)
        o.start(0)
    }

    function stopMusic() {
        g.gain.exponentialRampToValueAtTime(
            0.00001, context.currentTime + 0.04
        )
    }

    if (!WebAssembly.instantiateStreaming) {
        // polyfill
        WebAssembly.instantiateStreaming = async (resp, importObject) => {
            const source = await (await resp).arrayBuffer();
            return await WebAssembly.instantiate(source, importObject);
        };
    }

    const go = new Go();
    let mod, inst;
    WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then(
        async result => {
            mod = result.module;
            inst = result.instance;
            await go.run(inst);
        }
    );

    document.getElementById('file').addEventListener('change', function () {
        var reader = new FileReader();
        reader.onload = function () {

            var arrayBuffer = this.result;
            document.buffer = new Uint8Array(arrayBuffer);
        }
        reader.readAsArrayBuffer(this.files[0]);

    }, false);
</script>
</body>
</html>